/*
 * Copyright 2021 Lightbend Inc.
 */

package car;

import com.akkaserverless.javasdk.testkit.junit.AkkaServerlessTestkitResource;

import car.metrics.api.CarMetricsServiceClient;
import car.metrics.api.CarMetricsApi;
import car.metrics.api.CarMetricsApi;

import org.junit.ClassRule;
import org.junit.Test;

import static org.junit.Assert.assertEquals;

public class CarMetricsIntegrationTest {

  @ClassRule
  public static final AkkaServerlessTestkitResource testkit =
      new AkkaServerlessTestkitResource(Main.SERVICE);

  // This class is outgenerated by Akka gRPC from car.metrics.api.CarMetrics
  private final CarMetricsServiceClient client;

  public CarMetricsIntegrationTest() {
    this.client =
        CarMetricsServiceClient.create(testkit.getGrpcClientSettings(), testkit.getActorSystem());
  }

  CarMetricsApi.CarMetrics getCarMetrics(String carId) throws Exception {
    return client
        .getCarMetrics(CarMetricsApi.CarId.newBuilder().setCarId(carId).build())
        .toCompletableFuture()
        .get();
  }

  void recordChargeLevel(String carId, int remainingWatts, int wattsCapacity) throws Exception {
    CarMetricsApi.CarMetrics metrics =
        CarMetricsApi.CarMetrics.newBuilder()
            .setRemainingWatts(remainingWatts)
            .setWattsCapacity(wattsCapacity)
            .build();

    client
        .recordChargeLevel(
            CarMetricsApi.ChargeLevel.newBuilder().setCarId(carId).setMetrics(metrics).build())
        .toCompletableFuture()
        .get();
  }

  @Test
  public void emptyStatesByDefault() throws Exception {
    assertEquals("not stats", 0, getCarMetrics("car1").getRemainingWatts());
  }

  @Test
  public void chargeCar() throws Exception {
    final String carId = "car2";
    recordChargeLevel(carId, 40, 100);
    assertEquals("not stats", 40, getCarMetrics(carId).getRemainingWatts());
  }
}
